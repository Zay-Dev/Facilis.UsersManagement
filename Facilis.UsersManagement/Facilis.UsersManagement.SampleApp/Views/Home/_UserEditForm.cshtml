@using Facilis.UsersManagement.Helpers
@using Facilis.UsersManagement.SampleApp.Enums
@model Facilis.UsersManagement.Abstractions.User

@{
    var isAdmin = this.Context.User.IsInRole(RoleTypes.Administrator);
    var isNewUser = Model == null;
    var profile = Model?.Profile;
    var data = new
    {
        Model?.Id,
        profile?.Email,
        profile?.Nickname,
        profile?.FirstName,
        profile?.LastName,
        Username = Model?.Username.ToLower(),
        Password = "",
    };
}

<script type="text/javascript">
    const data = {
        form: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(data)),

        isAdmin: @($"{isAdmin}".ToLower()),
        init: function () {
            that = this;
        },
    };
    const add = () => {
        return cssLoader.show()
            .then(() => axios.post(`/api/users/${data.form.username}?password=${data.form.password}`, data.form))
            .then(() => document.location.reload());
    };
    const update = () => {
        return cssLoader.show()
            .then(() => axios.patch('/api/users/@Model?.Id/profiles', data.form))
            .then(() => document.location.reload());
    };
</script>

<div x-data="data">
    <div class="mt-4">
        <div class="row">
            <div class="col-12 col-md-6 offset-md-3">
                <div class="card p-4 pb-2">
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-4">Profile</h5>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3"
                         x-show="isAdmin">
                        <div class="col-4">Username</div>

                        <div class="col-8">
                            <template x-if="!@($"{isNewUser}".ToLower())">
                                <span x-text="form.username"></span>
                            </template>

                            <template x-if="@($"{isNewUser}".ToLower())">
                                <input class="form-control"
                                       x-model="form.username" />
                            </template>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3"
                         x-show="@($"{isNewUser}".ToLower()) && isAdmin">
                        <div class="col-4">Password</div>

                        <div class="col-8">
                            <template x-if="@($"{isNewUser}".ToLower())">
                                <input class="form-control" type="password"
                                       x-model="form.password"
                                       x-on:mouseover="$el.setAttribute('type', 'text')"
                                       x-on:mouseleave="$el.setAttribute('type', 'password')" />
                            </template>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3"
                         x-show="form.email || isAdmin">
                        <div class="col-4">Email</div>

                        <div class="col-8">
                            <template x-if="!isAdmin">
                                <span x-text="form.email"></span>
                            </template>

                            <template x-if="isAdmin">
                                <input class="form-control"
                                       x-model="form.email" />
                            </template>
                        </div>
                    </div>

                    <div class="row align-items-center mb-3">
                        <div class="col-4">Nickname</div>

                        <div class="col-8">
                            <input class="form-control"
                                   x-model="form.nickname" />
                        </div>
                    </div>

                    <div class="row align-items-center mb-3">
                        <div class="col-4">First Name</div>

                        <div class="col-8">
                            <input class="form-control"
                                   x-model="form.firstName" />
                        </div>
                    </div>

                    <div class="row align-items-center mb-3">
                        <div class="col-4">Last Name</div>

                        <div class="col-8">
                            <input class="form-control"
                                   x-model="form.lastName" />
                        </div>
                    </div>

                    <div class="row align-items-center mb-3"
                         x-show="@($"{profile != null}".ToLower())">
                        <div class="col-12 small text-end">
                            @profile?.LastSignInAtUtc.ToString("HH:mm:ss dd MMM, yyyy")
                            (+00:00)
                        </div>
                    </div>

                    <hr />

                    <div class="row">
                        <div class="col-12">
                            <div class="text-end">
                                <a href="~/" class="btn btn-link"
                                   x-show="isAdmin">
                                    Back
                                </a>

                                <button class="btn btn-primary ms-2"
                                        x-on:click="@(isNewUser ? "add()" : "update()")">
                                    @(isNewUser ? "Add" : "Update")
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>